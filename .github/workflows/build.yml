name: Build (nRF Connect SDK)

on:
  push:
  pull_request:
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      NCS_REV: v3.2.1
      BOARD: promicro_nrf52840/nrf52840

    steps:
      - name: Checkout app repo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y git cmake ninja-build curl xz-utils file

      - name: Install nrfutil + toolchain-manager + toolchain
        run: |
          curl -L -o nrfutil https://developer.nordicsemi.com/.pc-tools/nrfutil/x64-linux/nrfutil
          chmod +x nrfutil

          ./nrfutil install toolchain-manager
          ./nrfutil toolchain-manager install --ncs-version ${NCS_REV}
          ./nrfutil toolchain-manager env --as-script > export_env.sh
          
          python -m pip install --upgrade pip
          pip install west

      - name: Init NCS workspace (west)
        run: |
          mkdir -p ncs
          cd ncs || exit
          west init -m https://github.com/nrfconnect/sdk-nrf --mr ${NCS_REV}
          west update
          west zephyr-export
          python -m pip install -r zephyr/scripts/requirements.txt

      - name: Build firmware
        run: |
          source ../export_env.sh
          west build -p always -b "${BOARD}" -s ..
        working-directory: ncs

      - name: Prepare GitHub Pages
        working-directory: ncs
        run: |
          mkdir -p _site
          cp -r build/*.hex _site
          cat > _site/index.html << EOF
          <!DOCTYPE html>
          <html>
          <head>
            <title>Hybrid Tag Build Artifacts</title>
          </head>
          <body>
            <h1>Hybrid Tag Build Artifacts</h1>
            <p style="color: #666; font-size: 0.9em">Built: $(date -u +"%Y-%m-%d %H:%M:%S UTC")</p>
            <p>Board: ${BOARD}</p><p>NCS Version: ${NCS_REV}</p>
            <h2>Download Files:</h2>
            <ul>
          EOF
          
          for file in _site/*; do
            if [ -f "$file" ] && [ "$(basename "$file")" != "index.html" ]; then
              filename=$(basename "$file")
              echo "<li><a href=\"$filename\">$filename</a></li>" >> _site/index.html
            fi
          done

          cat >> _site/index.html << 'EOF'
            </ul>
          </body>
          </html>
          EOF

      - name: Upload to GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: ncs/_site

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
