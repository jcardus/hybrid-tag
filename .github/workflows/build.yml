name: Build (nRF Connect SDK)

on:
  push:
  pull_request:
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      NCS_REV: v3.2.1
      BOARD: promicro_nrf52840/nrf52840

    steps:
      - name: Checkout app repo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y git cmake ninja-build curl xz-utils file

      - name: Install nrfutil + toolchain-manager + toolchain
        run: |
          # Install nrfutil (Linux x64)
          curl -L -o nrfutil https://developer.nordicsemi.com/.pc-tools/nrfutil/x64-linux/nrfutil
          chmod +x nrfutil

          # Install toolchain for this NCS version
          ./nrfutil install toolchain-manager
          ./nrfutil toolchain-manager install --ncs-version ${NCS_REV}
          
          # Export toolchain env vars into a script we can source
          ./nrfutil toolchain-manager env --as-script > export_env.sh
          
          # Install west
          python -m pip install --upgrade pip
          pip install west

      - name: Init NCS workspace (west)
        run: |
          mkdir -p ncs
          cd ncs || exit
          west init -m https://github.com/nrfconnect/sdk-nrf --mr ${NCS_REV}
          west update
          west zephyr-export
          python -m pip install -r zephyr/scripts/requirements.txt

      - name: Build your app
        run: |
          source ../export_env.sh
          west build -p always -b "${BOARD}" -s "${GITHUB_WORKSPACE}" -d build
        working-directory: ncs

      - name: Prepare GitHub Pages
        run: |
          mkdir -p _site
          cp -r ncs/build/zephyr/zephyr.* _site/ 2>/dev/null || true
          cp -r ncs/build/zephyr/*.hex _site/ 2>/dev/null || true
          cp -r ncs/build/zephyr/*.bin _site/ 2>/dev/null || true
          cp -r ncs/build/zephyr/*.uf2 _site/ 2>/dev/null || true

          # Get current date and time
          BUILD_DATE=$(date -u +"%Y-%m-%d %H:%M:%S UTC")

          # Create an index.html with links to the artifacts
          cat > _site/index.html << EOF
          <!DOCTYPE html>
          <html>
          <head>
            <title>Hybrid Tag Build Artifacts - ${BUILD_DATE}</title>
            <style>
              body { font-family: sans-serif; margin: 40px; }
              h1 { color: #333; }
              ul { list-style-type: none; padding: 0; }
              li { margin: 10px 0; }
              a { color: #0066cc; text-decoration: none; }
              a:hover { text-decoration: underline; }
              .build-info { color: #666; font-size: 0.9em; }
            </style>
          </head>
          <body>
            <h1>Hybrid Tag Build Artifacts</h1>
            <p class="build-info">Built: ${BUILD_DATE}</p>
            <p>Board: nrf52840dk/nrf52840</p>
            <p>NCS Version: v2.8.0</p>
            <h2>Download Files:</h2>
            <ul>
          EOF

          # Add links for each file
          for file in _site/*; do
            if [ -f "$file" ] && [ "$(basename "$file")" != "index.html" ]; then
              filename=$(basename "$file")
              echo "      <li><a href=\"$filename\">$filename</a></li>" >> _site/index.html
            fi
          done

          cat >> _site/index.html << 'EOF'
            </ul>
          </body>
          </html>
          EOF

          echo "Files prepared for GitHub Pages:"
          ls -lh _site/

      - name: Upload to GitHub Pages
        uses: actions/upload-pages-artifact@v3

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
